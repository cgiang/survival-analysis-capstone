---
title: "Capstone Project"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(survival)
```

```{r}
# for checking distribution
CoxSnell = function(cs,status,xlim=NULL,ylim=NULL)
{
kmcs = survfit( Surv(jitter(cs,amount=(max(cs)-min(cs))/1000),status) ~ 1 )$surv

plot( log(-log(kmcs)) ~ sort(log(cs)) ,
      xlab="log(Cox-Snell)", ylab="log(-log(S(Cox-Snell)))", xlim=xlim, ylim=ylim )

abline(0,1,col='red')
}
```

[Data Source](https://www.kaggle.com/proselotis/financial-ipo-data)

```{r}
IPO = read.csv("IPODataFull.csv")
```

```{r}
# fix typo
# IPO[IPO$Symbol=="EGL",]%>% select(c("exactDateFounded", "YearFounded"))
IPO[1040,"YearFounded"]=2011
# IPO[IPO$Symbol=="EGL",]%>% select(c("exactDateFounded", "YearFounded"))
```

## Data Cleaning

```{r}
# default date in month
defaultDay = "15"
# default date in year
defaultDate ="06-30"
```

```{r,results='hide'}
# drop na in YearFounded
IPO = IPO[!is.na(IPO$YearFounded),]
# look at original datetime format
# IPO %>% select(c("ipoDate", "YearFounded", "exactDateFounded"))
```

```{r,results='hide'}
# reformat ipoDate into IPODate
IPO$IPODate = as.Date(IPO$ipoDate,format='%m/%d/%y %H:%M')
# drop ipoDate
IPO = subset(IPO, select = -ipoDate)
# look again
# IPO %>% select(c("IPODate", "YearFounded", "exactDateFounded"))
```

```{r}
# reformat exactDateFounded into DateFounded
DateFounded = c(Sys.Date())
for (i in 1:nrow(IPO)){
  rawDate = IPO$exactDateFounded[i]
  len = nchar(gsub('[^,]', '', rawDate)) +1L
  if (len==1){
    mydate = paste0(rawDate,defaultDate)
    DateFounded = c(DateFounded, as.Date(mydate,format='%Y%m-%d'))
  } else if (len==2){
    mydate = paste0(rawDate,defaultDay)
    DateFounded = c(DateFounded, as.Date(mydate,format='%B,%Y%d'))
  } else if (len==3){
    DateFounded = c(DateFounded, as.Date(rawDate,format="%B,%d,%Y"))
  } else if (len==4){
    DateFounded = c(DateFounded, as.Date("June,28,1951", format="%B,%d,%Y")) # I looked at this exception
  }
}
IPO$DateFounded = DateFounded[-1]
# drop exactDateFounded
IPO = subset(IPO, select = -exactDateFounded)
```

```{r}
# create DaysToIPO, IPOYear and YearsToIPO
IPO$DaysToIPO = as.numeric(difftime(IPO$IPODate, IPO$DateFounded, units = "days"))
IPO$IPOYear = format(IPO$IPODate,"%Y")
IPO$YearsToIPO = as.numeric(IPO$IPOYear) - as.numeric(IPO$YearFounded)
# Filter out negative DaysToIPO
IPO = IPO %>% filter(DaysToIPO >= 0)
# look again
# IPO %>% select(c("IPOYear", "IPODate", "YearFounded", "DateFounded", "DaysToIPO", "YearsToIPO"))
```

```{r}
# subset of the original data set without TVC or anything after Fiscal_year
IPO_sub <- select (IPO, DaysToIPO, YearsToIPO, LastSale, Sector, Industry, CEOTakeOver, CEOAge, CEOGender, PresidentAge, Revenue, netIncome, lastFiscalYearGrowth, employees)
```

```{r}
# make numeric Revenue
for (i in 1:nrow(IPO_sub)){
  x=gsub("\\$", "", IPO_sub$Revenue[i])
  if (endsWith(x,"B")){
    x<-as.numeric(gsub("B", "", x))
    x=x*1000000000
  }
  else if (endsWith(x,"M")){
    x<-as.numeric(gsub("M", "", x))
    x=x*1000000
  }
  IPO_sub$Revenue[i]<-x
}

# make numeric netIncome
for (i in 1:nrow(IPO_sub)){
  x=gsub("\\$", "", IPO_sub$netIncome[i])
  if (endsWith(x,"B")){
    x<-as.numeric(gsub("B", "", x))
    x=x*1000000000
  }
  else if (endsWith(x,"M")){
    x<-as.numeric(gsub("M", "", x))
    x=x*1000000
  }
  IPO_sub$netIncome[i]<-x
}
```

```{r,message=FALSE, warning=FALSE}
IPO_sub$Revenue<-as.numeric(IPO_sub$Revenue)
IPO_sub$netIncome<-as.numeric(IPO_sub$netIncome)
IPO_sub$lastFiscalYearGrowth<-as.numeric(IPO_sub$lastFiscalYearGrowth)
IPO_sub$employees<-as.numeric(IPO_sub$employees)
IPO_sub$Sector<-as.factor((IPO_sub$Sector))
IPO_sub$Industry<-as.factor((IPO_sub$Industry))
IPO_sub$CEOGender<- as.factor(IPO_sub$CEOGender)
summary(IPO_sub)
```

## Exploratory Analysis 

```{r, message=FALSE, fig.height=7}
data<-select(IPO_sub,-Sector,-Industry,-CEOGender)
library(pcalg)
suff_stat <- list(C = cor(data), n = nrow(data))
pc_data <- pc(suff_stat, indepTest = gaussCItest, labels = colnames(data), alpha = 0.05, skel.method = "stable.fast")
plot(pc_data, main = "pcalg graph",  cex.main=1.5, cex.sub=2.5)
```

```{r}
library(ggplot2)
#ggplot(data=IPO_sub,aes(x=LastSale,y=DaysToIPO))+geom_point()+geom_smooth()
ggplot(data=IPO_sub,aes(x=LastSale,y=DaysToIPO))+geom_point()+geom_smooth()+xlim(0, 35.9800)+ylim(0,40000)
#ggplot(data=IPO_sub,aes(x=Revenue,y=DaysToIPO))+geom_point()+geom_smooth()
ggplot(data=IPO_sub,aes(x=Revenue,y=DaysToIPO))+geom_point()+geom_smooth()+xlim(0, 1.625e+09)+ylim(0,40000)
#ggplot(data=IPO_sub,aes(x=employees,y=DaysToIPO))+geom_point()+geom_smooth()
ggplot(data=IPO_sub,aes(x=employees,y=DaysToIPO))+geom_point()+geom_smooth()+xlim(0, 3860)+ylim(0,40000)
```

```{r}
# omit outlier (max value of Revenue, LastSale)
IPO_sub2 = IPO_sub %>% 
  filter (Revenue < 5.579e+13, LastSale < 1441.5000) 
IPO_sub3 = IPO_sub %>%
  filter (CEOGender == "male" | CEOGender == "mostly_male" | CEOGender == "female" | CEOGender == "mostly_female")
ggplot(data=IPO_sub2,aes(x=LastSale,y=DaysToIPO))+geom_point()+geom_smooth()
ggplot(data=IPO_sub2,aes(x=Revenue,y=DaysToIPO))+geom_point()+geom_smooth()
ggplot(data=IPO_sub2,aes(x=employees,y=DaysToIPO))+geom_point()+geom_smooth()
```

```{r fig.width=9, fig.height=6}
# ggplot(data=IPO_sub,aes(x=LastSale,y=DaysToIPO,color=factor(Sector)))+geom_point()+geom_smooth()
# 
# # Alternatively
# ggplot(IPO_sub,aes(x=LastSale,y=DaysToIPO)) +
#     geom_boxplot() +
#     facet_grid(~Sector)

ggplot(IPO_sub,aes(x=Sector,y=DaysToIPO)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90))

# no clear trend 
# ggplot(IPO_sub3,aes(x=CEOGender,y=DaysToIPO)) +
#   geom_boxplot() + 
#   theme(axis.text.x = element_text(angle = 90))
```

```{r}
# ggplot(data=IPO_sub,aes(x=LastSale,y=DaysToIPO,color=factor(daysProfitGrouped)))+geom_point()+geom_smooth()

# Alternatively
# ggplot(IPO_sub,aes(x=LastSale,y=DaysToIPO)) +
#     geom_boxplot() +
#     facet_grid(~daysProfitGrouped)
```

#### Check interactions

```{r fig.width=9, fig.height=6}
# No interaction effect with Sector or CEOGender

# ggplot(IPO_sub,aes(x=Sector,y=employees)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
# ggplot(IPO_sub,aes(x=Sector,y=LastSale)) +geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
# ggplot(IPO_sub,aes(x=Sector,y=Revenue)) +geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
# ggplot(IPO_sub3,aes(x=CEOGender,y=LastSale)) +geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
```

## Modeling with DaysToIPO 

### Check PH assumption 

```{r}
# m1, m2 and m10 happen after IPO so they're commented out 
# the rest are commented out bc they violate the PH assumption 

#m1 = coxph( Surv( DaysToIPO) ~ DaysBetterThanSP , data=IPO_sub )
#plot( cox.zph(m1) )

#m2 = coxph( Surv( DaysToIPO) ~ daysProfit , data=IPO_sub )
#plot( cox.zph(m2) )

m3 = coxph( Surv( DaysToIPO) ~ Revenue , data=IPO_sub )
plot( cox.zph(m3) )

m4 = coxph( Surv( DaysToIPO) ~ netIncome , data=IPO_sub )
plot( cox.zph(m4) )

#m5 = coxph( Surv( DaysToIPO) ~ CEOAge , data=IPO_sub )
#plot( cox.zph(m5) )

#m6 = coxph( Surv( DaysToIPO) ~ PresidentAge , data=IPO_sub )
#plot( cox.zph(m6) )

#m7 = coxph( Surv( DaysToIPO) ~ lastFiscalYearGrowth , data=IPO_sub )
#plot( cox.zph(m7) )

#m8 = coxph( Surv( DaysToIPO) ~ employees , data=IPO_sub )
#plot( cox.zph(m8) )

m9 = coxph( Surv( DaysToIPO) ~ LastSale , data=IPO_sub )
plot( cox.zph(m9) )

#m10 = coxph( Surv( DaysToIPO) ~ MarketCap , data=IPO_sub )
#plot( cox.zph(m10) )

#m11 = coxph( Surv( DaysToIPO) ~ Sector , data=IPO_sub )
#plot( cox.zph(m11) )

#m12 = coxph( Surv( DaysToIPO) ~ Industry , data=IPO_sub )
#plot( cox.zph(m12) )

#m13 = coxph( Surv( DaysToIPO) ~ CEOTakeOver , data=IPO_sub )
#plot( cox.zph(m13) )

#m14 = coxph( Surv( DaysToIPO) ~ CEOAge , data=IPO_sub )
#plot( cox.zph(m14) )

#m15 = coxph( Surv( DaysToIPO) ~ CEOGender , data=IPO_sub )
#plot( cox.zph(m15) )

#m16 = coxph( Surv( DaysToIPO) ~ PresidentAge , data=IPO_sub )
#plot( cox.zph(m16) )
```

```{r}
# only m3, m4, m9 (Revenue, netIncome, LastSale satisfy the PH assumption)

#cox.zph(m1) ## <  0.05
#cox.zph(m2) ## >  0.05
cox.zph(m3) ## >  0.05
cox.zph(m4) ## >  0.05
#cox.zph(m5) ## <  0.05
#cox.zph(m6) ## <  0.05
#cox.zph(m7) ## <  0.05
#cox.zph(m8) ## <  0.05
cox.zph(m9) ## >  0.05
#cox.zph(m10) ## <  0.05
#cox.zph(m11) ## <  0.05
#cox.zph(m12) ## <  0.05
#cox.zph(m13) ## <  0.05
#cox.zph(m14) ## <  0.05
#cox.zph(m15) ## <  0.05
#cox.zph(m16) ## <  0.05
```

# Testing more covariates - start

```{r}
coxph(Surv(DaysToIPO)~LastSale+employees+strata(Industry)+strata(Sector)+strata(CEOGender)+CEOAge+PresidentAge+Revenue+netIncome+lastFiscalYearGrowth,data=IPO_sub)
```

```{r}
coxph(Surv(DaysToIPO)~CEOAge,data=IPO_sub) # significant
coxph(Surv(DaysToIPO)~PresidentAge,data=IPO_sub) # significant
# coxph(Surv(DaysToIPO)~netIncome,data=IPO_sub) # insignificant
# coxph(Surv(DaysToIPO)~lastFiscalYearGrowth,data=IPO_sub) # insignificant
```

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~LastSale+employees+factor(Sector)+CEOAge,data=IPO_sub,dist="weibull")) 
# significant? -- see below
# should we include CEOAge?
```

# Testing more covariates - end

```{r}
coxph(Surv(DaysToIPO)~LastSale,data=IPO_sub) # significant
```

```{r}
coxph(Surv(DaysToIPO)~employees,data=IPO_sub) # significant
# coxph(Surv(DaysToIPO)~Revenue,data=IPO_sub) # not significant
```

```{r}
#coxph(Surv(DaysToIPO)~LastSale+employees,data=IPO_sub) # significant
coxph(Surv(DaysToIPO)~LastSale+strata(employees),data=IPO_sub) # insignificant
#coxph(Surv(DaysToIPO)~LastSale+employees+strata(Sector),data=IPO_sub) # significant
coxph(Surv(DaysToIPO)~LastSale+strata(employees)+strata(Sector),data=IPO_sub) # insignificant
#coxph(Surv(DaysToIPO)~LastSale+employees+strata(Industry),data=IPO_sub) # significant
coxph(Surv(DaysToIPO)~LastSale+strata(employees)+strata(Industry),data=IPO_sub) # insignificant
```

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~LastSale+employees+factor(Sector),data=IPO_sub,dist="weibull")) 
# significant? -- see below
```

```{r}
summary(survreg(Surv(DaysToIPO)~employees+CEOAge,data=IPO_sub,dist="gaussian")) # significant
```

```{r}
# IPO_sub4 is a copy of IPO_sub, but with missing values in employees and CEOAge imputed with mean values 
# used for checking distribution appropriateness
IPO_sub4 = cbind(IPO_sub)
IPO_sub4$employees[is.na(IPO_sub4$employees)] = mean(IPO_sub4$employees, na.rm = TRUE)
IPO_sub4$CEOAge[is.na(IPO_sub4$CEOAge)] = mean(IPO_sub4$CEOAge, na.rm = TRUE)
```

```{r}
# normal distribution is not appropriate
CS = -log( 1 - pnorm( IPO_sub4$DaysToIPO , -7.84e+02+5.32e-02*IPO_sub4$employees+1.11e+02*IPO_sub4$CEOAge, 9644) ) 
CoxSnell( CS , rep(1,nrow(IPO_sub4)) )
```

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~employees+CEOAge,data=IPO_sub,dist="exponential")) # significant
```

```{r}
# exponential distribution is not appropriate
CS = -log( 1 - pexp( IPO_sub4$DaysToIPO , 1/exp(7.40+1.36e-05*IPO_sub4$employees+2.00e-02*IPO_sub4$CEOAge)) ) 
CoxSnell( CS , rep(1,nrow(IPO_sub4)) )
```

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~employees+CEOAge,data=IPO_sub,dist="weibull")) # significant
```

```{r}
# weibull distribution is kinda appropriate but not really
CS = -log( 1 - pweibull( IPO_sub4$DaysToIPO , 
                         shape = 1/1.48,  
                         scale = exp(7.21+1.15e-05*IPO_sub4$employees+1.86e-02*IPO_sub4$CEOAge)) ) 
CoxSnell( CS , rep(1,nrow(IPO_sub4)) )
```

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~employees+CEOAge,data=IPO_sub,dist="lognormal")) # CEOAge not significant
```

```{r}
# lognormal distribution is not appropriate 
CS = -log( 1 - plnorm( IPO_sub4$DaysToIPO , 
                         7.00+5.03e-06*IPO_sub4$employees+8.24e-03*IPO_sub4$CEOAge,  
                         1.86) ) 
CoxSnell( CS , rep(1,nrow(IPO_sub4)) )
```

```{r}
# netIncome is a function of Revenue so I'm not sure if they should be in the same model 

#md2=survreg(Surv(DaysToIPO)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="gaussian")
#summary(md2)
```

```{r}
#md3=survreg(Surv(DaysToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="exponential")
#summary(md3)
```

```{r}
#md4=survreg(Surv(DaysToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="weibull")
#summary(md4)
```

```{r}
#md5=survreg(Surv(DaysToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="lognormal")
#summary(md5)
```

### Model comparison

#### is including Sector worthwhile? Yes

```{r}
summary(survreg(Surv(DaysToIPO+0.0001)~LastSale+employees,data=IPO_sub,dist="weibull"))$loglik[2]
summary(survreg(Surv(DaysToIPO+0.0001)~LastSale+employees+factor(Sector),data=IPO_sub,dist="weibull"))$loglik[2]
1 - pchisq(2*(-22486.6+22555.74),12) # = 0
```

#### weibull vs normal (weibull) 

agrees with CS plot

```{r}
loglik_weibull = -20797
loglik_normal = -23336.4
loglik_exponential = -21154.8
loglik_lognormal = -20994.6

# AIC - not nested 
2*(4-(loglik_weibull))
2*(4-(loglik_normal))
```

#### weibull vs exponential (weibull)

agrees with CS plot

```{r}
# LRT - nested
ts=2*(loglik_weibull-(loglik_exponential))
1-pchisq(ts,1)

# AIC
2*(4-(loglik_weibull))
2*(3-(loglik_exponential))
```

#### weibull vs log-normal (weibull)

agrees with CS plot

```{r}
# AIC - not nested 
2*(4-(loglik_weibull))
2*(4-(loglik_lognormal))
```

#### normal vs exponential (exponential)

```{r}
# AIC - not nested
2*(4-(loglik_normal))
2*(4-(loglik_exponential))
```

#### normal vs log-normal (log-normal)

```{r}
# AIC - not nested
2*(4-(loglik_normal))
2*(4-(loglik_lognormal))
```

#### exponential vs log-normal (log-normal)

```{r}
# AIC - not nested 
2*(3-(loglik_exponential))
2*(4-(loglik_lognormal))
```

## Modeling with YearsToIPO 

```{r echo=FALSE, eval=FALSE}
ym1 = coxph( Surv( YearsToIPO) ~ DaysBetterThanSP , data=IPO_sub )
plot( cox.zph(ym1) )

ym2 = coxph( Surv( YearsToIPO) ~ daysProfit , data=IPO_sub )
plot( cox.zph(ym2) )

ym3 = coxph( Surv( YearsToIPO) ~ Revenue , data=IPO_sub )
plot( cox.zph(ym3) )

ym4 = coxph( Surv( YearsToIPO) ~ netIncome , data=IPO_sub )
plot( cox.zph(ym4) )

ym5 = coxph( Surv( YearsToIPO) ~ CEOAge , data=IPO_sub )
plot( cox.zph(ym5) )

ym6 = coxph( Surv( YearsToIPO) ~ PresidentAge , data=IPO_sub )
plot( cox.zph(ym6) )

ym7 = coxph( Surv( YearsToIPO) ~ lastFiscalYearGrowth , data=IPO_sub )
plot( cox.zph(ym7) )

ym8 = coxph( Surv( YearsToIPO) ~ employees , data=IPO_sub )
plot( cox.zph(ym8) )

ym9 = coxph( Surv( YearsToIPO) ~ LastSale , data=IPO_sub )
plot( cox.zph(ym9) )

ym10 = coxph( Surv( YearsToIPO) ~ MarketCap , data=IPO_sub )
plot( cox.zph(ym10) )
```

```{r echo=FALSE, eval=FALSE}
cox.zph(ym1) ## <  0.05
cox.zph(ym2) ## >  0.05
cox.zph(ym3) ## >  0.05
cox.zph(ym4) ## >  0.05
cox.zph(ym5) ## <  0.05
cox.zph(ym6) ## <  0.05
cox.zph(ym7) ## <  0.05
cox.zph(ym8) ## <  0.05
cox.zph(ym9) ## >  0.05
cox.zph(ym10) ## <  0.05
```

### Some models

```{r echo=FALSE, eval=FALSE}
ymd1=coxph(Surv(YearsToIPO)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub)
summary(ymd1)
```

```{r echo=FALSE, eval=FALSE}
ymd2=survreg(Surv(YearsToIPO)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="gaussian")
summary(ymd2)
```

```{r echo=FALSE, eval=FALSE}
ymd3=survreg(Surv(YearsToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="exponential")
summary(ymd3)
```

```{r echo=FALSE, eval=FALSE}
ymd4=survreg(Surv(YearsToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="weibull")
summary(ymd4)
```

```{r echo=FALSE, eval=FALSE}
ymd5=survreg(Surv(YearsToIPO+0.0001)~daysProfit+Revenue+netIncome+LastSale,data=IPO_sub,dist="lognormal")
summary(ymd5)
```

### Model comparison

#### weibull vs normal (weibull)

```{r echo=FALSE, eval=FALSE}
# AIC - not nested 
2*(6-(-7243.1))
2*(6-(-11323.5))
```

#### weibull vs exponential (weibull)

```{r echo=FALSE, eval=FALSE}
# LRT
ts=2*(-7243.1-(-8984.5))
1-pchisq(ts,1)

# AIC
2*(6-(-7243.1))
2*(5-(-8984.5))
```

#### weibull vs log-normal (weibull)

```{r echo=FALSE, eval=FALSE}
# AIC - not nested
2*(6-(-7243.1))
2*(6-(-7952.4))
```

#### normal vs exponential (exponential)

```{r echo=FALSE, eval=FALSE}
# AIC - not nested
2*(6-(-11323.5))
2*(5-(-8984.5))
```

#### normal vs log-normal (log-normal)

```{r echo=FALSE, eval=FALSE}
# AIC - not nested 
2*(6-(-11323.5))
2*(6-(-7952.4))
```

#### exponential vs log-normal (log-normal)

```{r echo=FALSE, eval=FALSE}
# AIC - not nested 
2*(5-(-8984.5))
2*(6-(-7952.4))
```
